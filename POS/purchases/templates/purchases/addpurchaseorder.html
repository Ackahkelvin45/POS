{% extends 'POS/layout.html'%}
{%load static%}

{%block body%}

<div id="container">
    <img src="http://placehold.it/3000x3000/cf5">
</div>

<div id="overlay">
    <div id="progstat"></div>
    <div id="progress"></div>
</div>

<div class="mt-20 max-vs:mt-[6.6rem]  ">
    {%if messages%}
{% for message in messages%}
{% if message.tags == 'success'%}

      
        <div id="alert" class="  flex items-center p-4 mb-4 text-green-800 border-t-4 border-green-300 bg-green-50 dark:text-green-400 dark:bg-gray-800 dark:border-green-800 absolute z-50  right-5" role="alert">
           
            <svg   class="flex-shrink-0 w-4 h-4" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
                <path d="M8.445 12.6675A.9.9 0 0 0 7.1424 13.91l2.5726 2.7448c.3679.3856.9884.3689 1.335-.036l5.591-7.0366a.9.9 0 0 0-1.3674-1.1705l-4.6548 5.9132a.4.4 0 0 1-.607.0252l-1.567-1.6826zM1.9995 12c0-5.5 4.5-10 10-10s10 4.5 10 10-4.5 10-10 10-10-4.5-10-10z"></path>
            </svg>
            <div class="ml-3 text-sm font-medium">
              {{message}}
            </div>
            <button type="button" class="ml-auto -mx-1.5 -my-1.5 bg-green-50 text-green-500 rounded-lg focus:ring-0  p-1.5 hover:bg-green-200 inline-flex items-center justify-center h-8 w-8 dark:bg-gray-800 dark:text-green-400 dark:hover:bg-gray-700"  data-dismiss-target="#alert-border-3" id="close">
              <span class="sr-only">Dismiss</span>
              <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
              </svg>
            </button>
        </div>

        {%else%}
        <div id="alert" class="flex items-center p-4 mb-4 text-red-800 border-t-4 border-red-300 bg-red-50 dark:text-red-400 dark:bg-gray-800 dark:border-red-800  absolute z-50  right-5" role="alert">
            <svg class="flex-shrink-0 w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
              <path d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5ZM9.5 4a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3ZM12 15H8a1 1 0 0 1 0-2h1v-3H8a1 1 0 0 1 0-2h2a1 1 0 0 1 1 1v4h1a1 1 0 0 1 0 2Z"/>
            </svg>
            <div class="ml-3 text-sm font-medium">
              {{message}}
            </div>
            <button type="button" class="ml-auto -mx-1.5 -my-1.5 bg-red-50 text-red-500 rounded-lg   p-1.5 hover:bg-red-200 inline-flex items-center justify-center h-8 w-8 dark:bg-gray-800 dark:text-red-400 dark:hover:bg-gray-700"  data-dismiss-target="#alert-border-2" id="close">
              <span class="sr-only">Dismiss</span>
              <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
              </svg>
            </button>
        </div>
        
        {%endif%}
        {%endfor%}
        {%endif%}
    <div class="rounded-3xl  border h-fit border-indigo-200  mx-4 mb-4 pb-10 ">
      
        <div class="w-full flex flex-row py-2 bg-gray-200 rounded-t-3xl px-8 space-x-4 ">
       

             <a href="{% url 'purchases:purchaseorderlist'%}" class="relative   flex justify-center items-center px-2 py-1  text-white   bg-indigo-700 rounded-md   focus:outline-none   ">
            
                <i class="mdi mdi-view-module-outline text-white text-base"></i>
                <span class="pl-2 mx-1 text-xs text-white">Purchase order list</span>
             </a>
        </div>
     <!-- component -->
<!-- component -->
<div class="  px-8 max-vs:px-2  mx-4">
    <div class="text-gray-700 my-1 text-md">Add New Purchase order</div>
    <hr class="h-[1px] w-full bg-gray-600 mb-2"/>



  
    <div class="flex w-full flex-row max-sm:flex-col max-sm:items-end  overflow-hidden sm:justify-between    items-center  h-full py-2   bg-slate-300 px-2">
     
        
                <div  class="  w-[50%] max-sm:w-full  h-full  flex justify-start items-start flex-row  ">
                    {% csrf_token %}
                    <div class="flex w-full  h-full flex-row  justify-start items-start">
                        <form method="post"  id="search-form"  class=" mb-2 max-sm:w-full  h-full  flex-col flex items-start justify-start max">
                            <label for="" class="text-sm text-gray-700   px-1">Search Product</label>
                            <div class=" w-full  h-full flex flex-row justify-start items-start"  id="bloodhound">
                                <input id="product-name" class=" typeahead w-full h-10  pl-4 pr-3  rounded-lg  border border-gray-400 outline-none focus:outline-none focus:ring-0 focus:border-gray-300" type="text"/>
                                <button  type="submit" class="  flex justify-center items-center  -ml-4 z-20  text-white  py-[0.12rem] px-2   bg-indigo-700 rounded-r-md   focus:outline-none   ">
            
                                    <i class="mdi mdi-magnify text-white text-3xl"></i>
                                    
                                 </button>   
                                            </div>
                                           
                        </form>
                       
                                         
                      </div>
                    
                       
                    </div>
                    {% if purchase_order%}
                    <form id="saveform" method="post" action="{% url 'purchases:save_purchase_order' %}" class=" max-sm:w-full w-[50%] h-full  flex justify-end items-end">

                    {%else%}
                    <form class="w-[50%] h-full  flex justify-end items-end max-sm:w-full">

                    {%endif%}

                      <div class="w-full mb-2  flex-col flex items-end justify-end">
                        {% csrf_token %}
                        
                        <div class=" w-full  flex flex-row justify-end items-center" >
                          <label for="" class="  flex justify-center items-center mx-1  px-1 max-lg:text-sm">select supplier:</label>
                          {{purchaseorderform.supplier}}
        
                          
                                
                        
                                        </div>
                      <div class="flex flex-row my-2 justify-end items-centr">
                        <label class="text-md mx-2  flex justify-center items-center max-lg:text-sm">add discount:</label>
                        {{purchaseorderform.discount}}
                                            </div>

                      <div class="flex flex-row justify-end items-center ">
                        <label class="text-md mx-1 flex justify-center items-center text-center max-lg:text-sm">Invoice Number:</label>
                   
                        {{purchaseorderform.invoice_number}}
                      </div>
                      

                    </div>
                     
                  
        
                  </form>
          
        </div>
        <div>
          <div class="relative overflow-x-auto shadow-md rounded-sm mt-10   ">
            
            <table id="product-table"  class="text-left w-full">
              <thead class=" flex  w-full text-xs text-gray-700 uppercase bg-gray-200">
                <tr class="flex w-full  justify-center items-center">
                  <th class="px-6 py-1 w-1/4">Name</th>
                  <th class="px-6 py-1 w-1/4">Cost price</th>
                  <th class="px-6 py-1 w-1/4">Available Quantity</th>
                  <th class="px-6 py-3 w-1/4">Order</th>
                </tr>
              </thead>
              <tbody class="bg-grey-light text-sm flex flex-col items-center justify-between overflow-y-scroll w-full" style="height: 25vh;">
                <tr class="flex w-full justify-center items-center ">
                  <td class="px-6 w-full break-words text-center">No records</td>
                
                </tr>
                
        
              </tbody>
            </table>
        </div>
        </div>



        <div class="relative overflow-x-auto shadow-md sm:rounded-lg mt-10  ">
          <div class="text-gray-700 my-1 text-md"> Purchase order List</div>
          <hr class="h-[1px] w-full bg-gray-600 mb-2"/>

          <table   class="text-left w-full">
            <thead class=" flex  w-full text-xs text-gray-700 uppercase bg-gray-200">
              <tr class="flex w-full  justify-center items-center">
                <th class="px-6 py-1 w-1/4">Product Name</th>
                <th class="px-6 py-1 w-1/4">Package Type</th>
                <th class="px-6 py-1 w-1/4">Quantity</th>
                <th class="px-6 py-3 w-1/4"> Cost Price</th>
                <th class="px-6 py-3 w-1/4">Total Cost Price</th>
                <th class="px-6 py-3 w-1/4">Action</th>
              </tr>
            </thead>
            <tbody class="bg-grey-light text-sm flex flex-col  text-left overflow-y-scroll w-full" style="height: 25vh;">
              {% if ordered_products%}
              {%for product in ordered_products%}
              <tr class="flex w-full border-b border-gray-100 py-1">
               <th scope="row" class="px-6 w-1/4 break-words">{{product.product.name}}</th>
               <td class="px-6 w-1/4 break-words">{{product.package_type}}</td>
               <td class="px-6 w-1/4 break-words">{{product.quantity}}</td>
               <td class="px-6 w-1/4 break-words">{{product.cost_unit_price}}</td>
               <td class="px-6 w-1/4 break-words">{{product.total_cost_price}}</td>

               <td class="px-6 flex flex-row ">
                <a href="{% url 'purchases:edit_item' product.id %}" class="cursor-pointer" ><i  class="mdi mdi-pencil text-indigo-700 text-lg"></i> </a>  <a href="{% url 'purchases:remove' product.id%}"> <i  class="mdi mdi-trash-can-outline text-indigo-700 text-lg ml-3"></i> </a>
            </td>
              </tr>
              {%endfor%}
              {%else%}
 
                 <tr class="flex w-full justify-center items-center ">
                   <td class="px-6 w-1/4 break-words">No records</td>
                 
                 </tr>
                 
 
          {%endif%}
       
      
            </tbody>
            <tfoot class="bg-slate-300 py-2  text-sm flex flex-col  text-left overflow-y-hidden w-full">
              <tr>
                <td class="px-6 max-sm:px-2 w-1/4 break-words max-sm:text-sm"><span class="font-semibold">PO Number:</span>{{purchase_order.order_number}}</td>
                <td class="px-6 w-1/4 break-words max-sm:px-2 max-sm:text-sm"> <span class="font-semibold">Total Quantity:</span>{{purchase_order.total_quantity}}</td>
                <td class="px-6 w-1/4 break-words max-sm:px-2 max-sm:text-sm"><span  class="font-semibold">Total Price:</span>{{purchase_order.total_cost_price}}</td>
                <td class="px-6 w-1/4 break-words" >
                  <div class=" sm:space-x-2 max-sm:px-2 max-sm:text-sm max-sm:flex flex-col  max-sm:space-y-2">
                  {% if purchase_order %}
                  <button id="savebutton" class="bg-green-500 px-3 py-1 font-bold rounded-md text-white">save</button>
                  <button id="deletebutton" data-url="{% url 'purchases:delete_purchaseorder'%}" class=" ml-2 max-sm:ml-0 bg-red-500 px-3 py-1 font-bold rounded-md text-white">cancel</button>
                  {%endif%}
                </div>
                </td>
              </tr>
            </tfoot>
          </table>
       
      </div>
      {% if purchase_order %}
      <div class=" mt-6 w-full flex flex-row bg-slate-200 border  border-slate-400 px-2 py-2">
      
        <a href="{% url 'purchases:remove_from_session' %}" class="flex flex-row text-xs text-gray-500  group cursor-pointer  justify-center items-center ">
            <i class="mdi mdi-plus font-bold   text-green-500 text-lg mr-1"></i>
            <span class="group-hover:underline ">Add New</span>

        
           
        
        </a>
        <span class="h-5 mx-1 bg-gray-500 w-[1px] mt-1"></span>
        <a href="{% url 'purchases:preview_as_pdf'%}" target="_blank" class="flex flex-row text-xs text-gray-500  group cursor-pointer justify-center items-center ">
            <i class="mdi mdi-printer text-gray-700 text-lg"></i>
            <span class="group-hover:underline ">Preview </span>
        
           
        
        </a>
        {% if purchase_order.supplier%}
        <span class="h-5 mx-1 mt-1 bg-gray-500 w-[1px] "></span>
        <a href="{% url 'purchases:send_purhase_order_as_email' purchase_order.id %}" class="flex flex-row text-xs text-gray-500  group cursor-pointer  justify-center items-center ">
            <i class="mdi mdi-email  text-gray-700 text-lg"></i>
            <span class="group-hover:underline ">send as email to supplier </span>

        
           
        
        </a>
        {%endif%}
    
     
        <span class="h-5 mx-1 bg-gray-500 w-[1px] mt-1"></span>
        <a href="{% url 'purchases:recieve_order' purchase_order.id%}" class="flex flex-row text-xs text-gray-500  group cursor-pointer  justify-center items-center ">
            <i class="mdi mdi-table-arrow-down font-bold   text-green-500 text-lg mr-1"></i>
            <span class="group-hover:underline ">recieve order</span>

        
           
        
        </a>
        
        <span class="h-5 mx-1 mt-1 bg-gray-500 w-[1px] "></span>
        <a href="" class="flex flex-row text-xs text-gray-500  group cursor-pointer  justify-center items-center ">
            <i class="mdi mdi-application-export text-gray-700 text-lg"></i>
            <span class="group-hover:underline ">download as csv</span>

        
           
        
        </a>
     
        

        
        
        
        
        
            </div>
            {%endif%}

    </div>



    </div>
</div>
</div>

  {%if modal%}
  <div class="fixed z-50 w-full h-screen bg-gray-600  bg-opacity-30 flex justify-center items-center">
    <div class=" w-[50%]  bg-white  rounded-md max-sm:w-[70%] max-vs:w-[90%] justify-center items-center flex flex-col">
      <div class="flex items-start justify-between w-full p-4 border-b rounded-t dark:border-gray-600">
        <h3 class="text-xl font-semibold text-gray-900 dark:text-white">
          {{product.name}}
        </h3>
        <button id="closebutton" type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ml-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" data-modal-hide="default-modal">
            <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
            </svg>
            <span class="sr-only">Close modal</span>
        </button>
    </div>
    {%if edit %}
    <form method="post" action="{% url 'purchases:edit_item_process' orderedproduct.id %}"   class="w-full  px-6 py-6 lg:px-8   justify-center items-center flex    ">{% csrf_token %}<div class="relative w-full max-w-md max-h-full">

    {%else%}
    <form method="post" action="{% url 'purchases:purchase_item'%}"   class="w-full  px-6 py-6 lg:px-8   justify-center items-center flex    ">{% csrf_token %}<div class="relative w-full max-w-md max-h-full">

    {%endif%}
    <div class=""><input class="hidden" name="product" value="{{product.id}}"/>

        <label for="email" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Package Type</label>{{productform.package_type}}</div>
        <div>
           <label  class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Quantity</label>{{productform.quantity}}</div><div class="mb-2"><label class="block mb-2 text-sm font-medium text-gray-900  ">Cost Price</label>{{productform.cost_unit_price}}
          </div >
          <div class="w-full justify-center items-center flex">
            <button type="submit" class="w-fit  text-white bg-blue-700  font-medium rounded-lg text-sm px-2 py-2.5 text-center  ">Order Now </button> 
          </div>
       
      </div></div>
    </form>
  </div>
</div>
    {%endif%}
  





<script>
   (function(){
  function id(v){ return document.getElementById(v); }
  function loadbar() {
    var ovrl = id("overlay"),
        prog = id("progress"),
        stat = id("progstat"),
        img = document.images,
        c = 0,
        tot = img.length;
    if(tot == 0) return doneLoading();

    function imgLoaded(){
      c += 1;
      var perc = ((100/tot*c) << 0) +"%";
      prog.style.width = perc;
      
      if(c===tot) return doneLoading();
    }
    function doneLoading(){
      ovrl.style.opacity = 0;
      setTimeout(function(){ 
        ovrl.style.display = "none";
      }, 1200);
    }
    for(var i=0; i<tot; i++) {
      var tImg     = new Image();
      tImg.onload  = imgLoaded;
      tImg.onerror = imgLoaded;
      tImg.src     = img[i].src;
    }    
  }
  document.addEventListener('DOMContentLoaded', loadbar, false);
}());


if (document.getElementById("close")){
document.getElementById("close").addEventListener("click",()=>{
    modal=document.getElementById("alert")
    modal.classList.add("hidden")
})
}
      
</script>
<style>
    .progress-container {
    width: 100%;
    height: 5px; /* Height of the progress bar */
    background-color: #ccc; /* Background color of the progress container */
}

.progress-bar {
    width: 0%;
    height: 100%;
    background-color: #3498db; /* Color of the progress bar */
    transition: width 0.3s; /* Transition effect for smoother progress */
}
</style>

 
<style>
    /* preloader.css */




img {
    width: 32.2%;
}

#overlay {
    position: absolute;
    z-index: 70;
    top: 0;
    left: 0;
    width: 100%; /* Make overlay cover the full width of the viewport */
    height: 10px; /* Make overlay cover the full height of the viewport */
    transition: 1s 0.4s;
}

#progress {
    height: 3px;
    background: rgb(99 102 241);
    position: absolute;
    width: 0; /* will be increased by JS */
    top: 0;
    left: 0; /* Start progress bar from the left */
}

#progstat {
    font-size: 0.7em;
    letter-spacing: 3px;
    position: absolute;
    top: 50%;
    left: 50%; /* Center horizontally */
    transform: translate(-50%, -50%); /* Center vertically and horizontally */
    width: 100%;
    text-align: center;
    color: #fff;
}
.tt-dropdown-menu{
    background-color:  rgb(226 232 240) !important;
    padding: 5px;
    border: rgb(179, 179, 179) solid !important;
    border-radius: 5px 5px 5px 5px !important;
    z-index: 1000 !important;
}
.twitter-typeahead{
    width: 100% !important;
}
</style>
<!--search functionality  of products in js-->
<!-- Search functionality of products in JS -->
<script>
    var states = [{% for product in products %} '{{ product.name }}', {% endfor %}];
    
    // Constructs the suggestion engine
    var engine = new Bloodhound({
      datumTokenizer: Bloodhound.tokenizers.obj.whitespace('value'),
      queryTokenizer: Bloodhound.tokenizers.whitespace,
      local: $.map(states, function(state) {
        return { value: state };
      })
    });
    
    // Kicks off the loading/processing of local and prefetch
    engine.initialize();
    
    $('#bloodhound .typeahead').typeahead({
      hint: true,
      highlight: true,
      minLength: 1
    },
    {
      name: 'states',
      displayKey: 'value',
      source: engine.ttAdapter(),
      templates: {
        empty: '<div class="flex flex-row "><span>No records found</span> </div>'
      }
    });

    
    $("#closebutton").click(()=>{
      url="{% url 'purchases:order'%}"
      window.location.href=url
    })
    </script>
    <script>
    $(document).ready(function() {
        $('#search-form').submit(function(e) {
              e.preventDefault();
            var csrfToken = Cookies.get('csrftoken');
          
            var productName = $('#product-name').val();
    
            $.ajax({
                type: 'POST',
                url: '{% url "purchases:search_product" %}', 
                headers: {
                'X-CSRFToken': csrfToken
                }, 
                data: { product_name: productName },
                success: function(data,xhr) {

                 
                    if ('error' in data) {
                        // Display an error message
                      
                    } else {
                      
                      console.log(data)
                 
                
                       if ( data.length > 0 ){
                        $('#product-table tbody').empty();
                
                    data.forEach(function(item) {
                        var row = $('<tr class="flex w-full border-b border-gray-100 py-1"></tr>');
                        row.append($('<th scope="row" class="px-6 w-1/4 break-words">' + item.fields.name + '</th>'));
                        row.append($('<td class="px-6 w-1/4 break-words">' + item.fields.cost_price + '</td>'));
                        row.append($('<td class="px-6 w-1/4 break-words">' + item.fields.available_quantity + '</td>'));
                        var orderItem = $(`<td class="px-6 w-1/4 break-words orderitem"><a class="hover:underline cursor-pointer text-green-500">order</a></td>`);
                        orderItem.find('a').attr('data-id', item.pk);

    
                         orderItem.find('a').attr('href', '{% url "purchases:order_item" 0 %}'.replace('0', item.pk));
                         row.append(orderItem);
                        $('#product-table tbody').append(row);
              
                    });

                       }
                       else{
                        $('#product-table tbody').html(
                          '<tr class="   bg-white  dark:border-gray-700"><td class="flex flex-row justify-center items-center">Product not found  <a href="{% url "product:productpage"%}" type="button" class="relative w-[20%] max-md:w-[30%]  max-vs:w-[50%]  flex justify-center items-center px-2 py-1  text-white   bg-indigo-700 rounded-md   focus:outline-none   "> <i class="mdi mdi-plus text-white text-base mx-2"></i> </a></td>/tr>'
                   
                  
                        );

                       }
                    }
                },
                error: function(xhr) {
                    // Handle AJAX error
                    if (xhr.status===404){
                      $('#product-table tbody').html(
                          '<tr class=" h-10 bg-white border-b dark:bg-gray-900 dark:border-gray-700"><td class="flex flex-row justify-center items-center">Product not found  <a href="{% url "product:productpage"%}" type="button" class="relative w-[20%] max-md:w-[30%]  max-vs:w-[50%]  flex justify-center items-center px-2 py-1  text-white   bg-indigo-700 rounded-md   focus:outline-none   "> <i class="mdi mdi-plus text-white text-base mx-2"></i> </a></td>/tr>'
                   
                  
                        );
                    
                    }
                    
                }
            });
        });
    });
    
</script>
<script>
  $("#savebutton").click(()=>{
$("#saveform").submit();
  })
</script>
<script>
    $("#deletebutton").click((item)=>{
      Swal.fire({
      icon: 'warning',
      text: "Do you want to delete this?",
      confirmButtonColor: '#26A69A',
      confirmButtonText:"Yes,I'm sure",
      showDenyButton:true,
      denyButtonText:"No",
      color:"white",
      background: 'rgba(0, 0, 0, 0.7)',
      allowEscapeKey: false,
      dangerMode:true,
      showClass: {
    popup: 'slow-animation-show'
  },
  hideClass: {
    popup: 'slow-animation-hide'
  }

    }).then((e)=>{
      if (e.isConfirmed){
      url=item.target.getAttribute("data-url")
     
     console.log("url",url)
     window.location.href=url
      }
      else{
          console.log("denied")
      }
    })
  })
    



</script>

<script>
    $(document).ready(function () {
        $('#package_select').change(function () {
            var selectedPackageId = $(this).val();
            $.ajax({
                url: '{% url "purchases:get_package_cost"%}',
                data: {'package_id': selectedPackageId},
                dataType: 'json',
                success: function (data) {
                    if (data.result === 'success') {
                        console.log('Cost Price: ' + data.cost_price);
                        $("#item_cost_price").val(`${data.cost_price}`);
                        // Handle the cost price here
                    } else {
                      $("#item_cost_price").val('{{product.cost_price}}');
                    }
                }
            });
        });
    });
</script>
<style>
  input::-webkit-outer-spin-button,
 input::-webkit-inner-spin-button {
   -webkit-appearance: none;
   margin: 0;
 }
 
 /* Firefox */
 input[type=number] {
   -moz-appearance: textfield;
 }


 .slow-animation-show {
  animation: swal2-show 0.5s; 
}

.slow-animation-hide {
  animation: swal2-hide 0.5s; 
}
   </style>

{%endblock%}